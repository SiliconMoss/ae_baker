name: Build and Release ZXP

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download ZXPSignCmd
        run: |
          mkdir -p bin
          curl -L -o bin/ZXPSignCmd "https://github.com/Adobe-CEP/CEP-Resources/raw/master/ZXPSignCmd/64bit/linux/ZXPSignCmd"
          chmod +x bin/ZXPSignCmd

      - name: Prepare Extension Folder
        run: |
          mkdir -p dist/ae_baker
          cp -r CSXS index.html styles.css js jsx dist/ae_baker/
          # Clean up any development-only files
          rm -f dist/ae_baker/.debug

      - name: Create Self-Signed Certificate
        run: |
          ./bin/ZXPSignCmd -selfSignedCert US NY "Antigravity" "AE Baker" password cert.p12
          
      - name: Sign and Package ZXP
        run: |
          ./bin/ZXPSignCmd -sign dist/ae_baker ae_baker_${{ github.ref_name }}.zxp cert.p12 password -tsa http://timestamp.digicert.com

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: "ae_baker_${{ github.ref_name }}.zxp"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
